<app-header></app-header>

<div class="profile-edit-container">
  <div class="container">
    <div class="page-header">
      <h1>Редактирование профиля</h1>
      <p class="page-subtitle">Управляйте своим профилем и контентом</p>
    </div>

    <div *ngIf="!profile" class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Загрузка профиля...</p>
    </div>

    <div *ngIf="profile" class="edit-layout">
      <!-- Навигация по разделам контента -->
      <nav class="content-nav">
        <a [routerLink]="['/me', 'profile']" routerLinkActive="active">
          <i class="fas fa-user-edit"></i> Настройки профиля
        </a>
        <a [routerLink]="['/me', 'home']" routerLinkActive="active">
          <i class="fas fa-blog"></i> Мой блог
        </a>
        <a [routerLink]="['/me', 'master-classes']" routerLinkActive="active">
          <i class="fas fa-graduation-cap"></i> Мастер-классы
        </a>
        <a [routerLink]="['/me', 'publications']" routerLinkActive="active">
          <i class="fas fa-file-alt"></i> Публикации
        </a>
        <a [routerLink]="['/me', 'certificates']" routerLinkActive="active">
          <i class="fas fa-certificate"></i> Сертификаты
        </a>
        <a [routerLink]="['/me', 'presentations']" routerLinkActive="active">
          <i class="fas fa-file-powerpoint"></i> Презентации
        </a>
        <a [routerLink]="['/me', 'parents']" routerLinkActive="active">
          <i class="fas fa-users"></i> Для родителей
        </a>
        <a [routerLink]="['/me', 'life']" routerLinkActive="active">
          <i class="fas fa-camera"></i> Жизнь в ДОУ
        </a>
        <a [routerLink]="['/me', 'reviews']" routerLinkActive="active">
          <i class="fas fa-star"></i> Отзывы
        </a>
      </nav>

      <!-- Навигация по настройкам профиля (показывается только на странице профиля) -->
      <nav class="edit-nav" *ngIf="isProfilePage()">
        <button class="nav-btn" [class.active]="activeSection === 'profile'" (click)="activeSection = 'profile'">
          <i class="fas fa-user"></i> Профиль
        </button>
        <button class="nav-btn" [class.active]="activeSection === 'social'" (click)="activeSection = 'social'">
          <i class="fas fa-share-alt"></i> Социальные сети
        </button>
        <button class="nav-btn" [class.active]="activeSection === 'location'" (click)="activeSection = 'location'">
          <i class="fas fa-map-marker-alt"></i> Местоположение
        </button>
      </nav>

      <!-- Profile Section (показывается только на странице профиля) -->
      <div *ngIf="activeSection === 'profile' && isProfilePage() && profile" class="edit-section card">
        <h2>Основная информация</h2>
        <form (ngSubmit)="updateProfile()">
          <div class="form-group">
            <label class="form-label">Фото</label>
            <div class="photo-upload">
              <img [src]="placeholder.getImageUrl(profile.photoUrl, 'avatar')" alt="Profile photo"
                class="profile-photo-preview" (error)="onImageError($event)" />
              <input type="file" accept="image/*" (change)="onPhotoUpload($event)" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-video"></i> Видео визитка
            </label>
            <div class="video-visitka-section">
              <div class="video-method-toggle">
                <button type="button" class="toggle-btn" [class.active]="!useVideoUpload" (click)="switchToVideoUrl()">
                  <i class="fas fa-link"></i> URL
                </button>
                <button type="button" class="toggle-btn" [class.active]="useVideoUpload"
                  (click)="switchToVideoFileUpload()">
                  <i class="fas fa-upload"></i> Загрузить файл
                </button>
              </div>
              <div *ngIf="!useVideoUpload" class="video-url-input">
                <input type="url" class="form-control" [(ngModel)]="profile.videoUrl" name="videoUrl"
                  placeholder="https://youtube.com/watch?v=... или https://youtu.be/..." />
                <small class="form-hint">Поддерживаются YouTube, Vimeo и другие видеохостинги</small>
              </div>
              <div *ngIf="useVideoUpload" class="video-file-input">
                <input type="file" class="form-control" (change)="onVideoFileSelect($event)" accept="video/*"
                  #videoFileInput />
                <small class="form-hint" *ngIf="selectedVideoFile">
                  Выбран файл: {{ selectedVideoFile.name }} ({{ (selectedVideoFile.size / 1024 / 1024).toFixed(2) }} MB)
                </small>
                <small class="form-hint" *ngIf="!selectedVideoFile">
                  Поддерживаемые форматы: MP4, WebM, MOV (макс. 100 MB)
                </small>
              </div>
              <div *ngIf="profile.videoUrl" class="video-preview">
                <video [src]="profile.videoUrl" controls class="video-preview-player"
                  *ngIf="!isVideoUrl(profile.videoUrl)"></video>
                <div *ngIf="isVideoUrl(profile.videoUrl)" class="video-url-preview">
                  <i class="fas fa-video"></i>
                  <span>Видео визитка: {{ profile.videoUrl }}</span>
                  <button type="button" class="btn-remove-video" (click)="removeVideo()" title="Удалить видео">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Имя</label>
            <input type="text" class="form-control" [(ngModel)]="profile.firstName" name="firstName" />
          </div>
          <div class="form-group">
            <label class="form-label">Фамилия</label>
            <input type="text" class="form-control" [(ngModel)]="profile.lastName" name="lastName" />
          </div>
          <div class="form-group">
            <label class="form-label">Отчество</label>
            <input type="text" class="form-control" [(ngModel)]="profile.patronymic" name="patronymic" />
          </div>
          <div class="form-group">
            <label class="form-label">О себе</label>
            <textarea class="form-control" [(ngModel)]="profile.bio" name="bio" rows="5"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </form>

        <!-- Danger Zone -->
        <div class="danger-zone">
          <h3>Опасная зона</h3>
          <p class="danger-warning">Удаление профиля необратимо. Все ваши данные будут безвозвратно удалены.</p>
          <button type="button" class="btn btn-danger" (click)="deleteProfile()">
            <i class="fas fa-trash-alt"></i> Удалить профиль
          </button>
        </div>
      </div>

      <!-- Social Links Section -->
      <div *ngIf="activeSection === 'social' && isProfilePage() && profile" class="edit-section card">
        <h2>Социальные сети</h2>
        <form (ngSubmit)="addSocialLink()" class="add-link-form">
          <div class="form-group">
            <label class="form-label">Платформа</label>
            <select class="form-control" [(ngModel)]="newSocialLink.platform" name="platform">
              <option *ngFor="let platform of socialPlatforms" [value]="platform">
                {{ getPlatformName(platform) }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">URL</label>
            <input type="text" class="form-control" [(ngModel)]="newSocialLink.url" name="url" required
              [placeholder]="newSocialLink.platform === 'TELEGRAM' ? 'AleksRukhman или @AleksRukhman' : 'https://example.com'" />
            <small *ngIf="newSocialLink.platform === 'TELEGRAM'" class="form-hint">
              Можно ввести просто username (например: AleksRukhman или &#64;AleksRukhman)
            </small>
          </div>
          <button type="submit" class="btn btn-primary">Добавить</button>
        </form>

        <div class="social-links-list">
          <div *ngFor="let link of socialLinks" class="social-link-item">
            <span class="platform">{{ getPlatformName(link.platform) }}</span>
            <a [href]="link.url" target="_blank">{{ link.url }}</a>
            <button class="btn btn-secondary" (click)="deleteSocialLink(link.id)">
              Удалить
            </button>
          </div>
        </div>
      </div>

      <!-- Location Section -->
      <div *ngIf="activeSection === 'location' && isProfilePage() && profile" class="edit-section card">
        <h2>Местоположение</h2>
        <form (ngSubmit)="updateProfile()">
          <div class="form-group">
            <label class="form-label">Адрес</label>
            <app-address-map mode="edit" [value]="profile.location || ''"
              placeholder="Детский сад 140 Нижегородская обл г Дзержинск ул Петрищева 29а"
              (addressSelected)="onAddressSelected($event)" (addressValid)="onAddressValid($event)">
            </app-address-map>
            <small class="form-hint">
              Начните вводить адрес, и вы увидите подсказки. Выберите нужный адрес из списка.
            </small>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="clearLocation()" [disabled]="!profile.location">
              <i class="fas fa-times"></i> Очистить
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="!isAddressValid">Сохранить</button>
          </div>
        </form>
      </div>

      <!-- Контент из дочерних роутов (посты, мастер-классы и т.д.) -->
      <div class="content-outlet" *ngIf="!isProfilePage()">
        <router-outlet></router-outlet>
      </div>
    </div>
  </div>